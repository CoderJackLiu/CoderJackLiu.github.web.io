---
layout: default
title: edit
---

<h1>博客编辑和发布界面</h1>

<!-- 引入 SimpleMDE 样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">

<!-- 样式调整 -->
<style>
  .editor {
    width: 100%;
    height: 70vh;
  }
  .editor .CodeMirror {
    height: 100%;
  }
  #resultMessage {
    margin-top: 20px;
    font-size: 16px;
  }
</style>

<!-- 博客名称输入框 -->
<label for="blog-title">博客名称:</label>
<input type="text" id="blog-title" placeholder="输入博客名称">

<!-- Markdown 编辑器 -->
<textarea id="markdown-editor" class="editor"></textarea>

<!-- 发布按钮 -->
<button id="publish-button">发布</button>

<!-- 消息显示区域 -->
<div id="resultMessage"></div>

<!-- 引入脚本 -->
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script src="https://cdn.auth0.com/js/auth0/9.13/auth0.min.js"></script>
<script>
  var auth0 = new auth0.WebAuth({
    domain: 'unrealdev-auth.us.auth0.com',
    clientID: 'LoFI0i6xPR0OLVXp6dVVbpavr6PAMruQ',
    redirectUri: 'https://unrealdev.cn/callback',
    responseType: 'token id_token',
    scope: 'openid profile'
  });

  var simplemde = new SimpleMDE({ element: document.getElementById("markdown-editor") });

  // 发布博客
  function publishBlog() {
    var markdownContent = simplemde.value();
    var blogTitle = document.getElementById('blog-title').value;
    if (!blogTitle) {
      showMessage('博客名称不能为空', 'error');
      return;
    }
    var filePath = `_posts/${new Date().toISOString().slice(0, 10)}-${blogTitle.replace(/ /g, '-').toLowerCase()}.md`;
    var token = localStorage.getItem('id_token');

    if (!token) {
      auth0.authorize();
      return;
    }

    // GitHub API 请求
    fetch('https://api.github.com/repos/CoderJackLiu/CoderJackLiu.github.io/contents/' + filePath, {
      method: 'PUT',
      headers: {
        'Authorization': 'token ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Update blog post',
        content: btoa(`# ${blogTitle}\n\n${markdownContent}`)
      })
    }).then(response => {
      if (response.ok) {
        showMessage('发布成功！', 'success');
      } else {
        response.json().then(data => {
          showMessage('发布失败：' + (data.message || response.statusText), 'error');
        });
      }
    });
  }

  // 显示消息
  function showMessage(message, type) {
    var resultMessage = document.getElementById('resultMessage');
    resultMessage.textContent = message;
    resultMessage.className = type;
  }

  // 发布按钮点击事件
  document.getElementById("publish-button").addEventListener("click", function() {
    var token = localStorage.getItem('id_token');
    if (token) {
      publishBlog();
    } else {
      auth0.authorize();
    }
  });

  // 监听消息事件以接收 token
  window.addEventListener('load', function() {
    auth0.parseHash(function(err, authResult) {
      if (authResult && authResult.accessToken && authResult.idToken) {
        localStorage.setItem('access_token', authResult.accessToken);
        localStorage.setItem('id_token', authResult.idToken);
        publishBlog();
      } else if (err) {
        console.log(err);
      }
    });
  });
</script>